proc Alice (s, qc) =
  (let i,j = randbit(), randbit())
  out!["Alice decides to send "; show (i,j); "\n"] .
  s?(x) . x >> match i, j .
               + 0b0,0b0 . I
               + 0b0,0b1 . X
               + 0b1,0b0 . Z
               + 0b1,0b1 . Z*X     .
  qc!x . _0
  
proc Bob(t, qc) =
  t?(y) . qc?(x) . 
  x,y >> Cnot . x>>H. x=?(i) . y=?(j) .
  out!["Bob receives "; show (i,j); "\n" ] .
  _0

proc Source(s:^qbit,t:^qbit) = 
  (newq x=|0>,y=|0>) x>>H . x,y>>CNot . s!x . t!y . _0 

proc System() = (new s,t,qc) 
                | Alice(s,qc) | Bob(t,qc) | Source(s,t)
